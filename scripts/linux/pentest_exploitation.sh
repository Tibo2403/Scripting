#!/bin/bash
# pentest_exploitation.sh - Phase d'exploitation (facultative)
# À utiliser uniquement avec l'accord explicite de la cible
# ⚠️  Utiliser uniquement avec autorisation explicite (voir README)
set -euo pipefail

SCRIPT_DIR="$(dirname "$(realpath "$0")")"
REPO_ROOT="$(realpath "$SCRIPT_DIR/../..")"
RESULTS_DIR="$REPO_ROOT/pentest_results"
SEARCH_FILE=""

# Parse optional parameters
while [[ $# -gt 0 ]]; do
    case "$1" in
        --results)
            RESULTS_DIR="$2"
            shift 2
            ;;
        --search-file)
            SEARCH_FILE="$2"
            shift 2
            ;;
        *)
            echo "Usage: $0 [--results dir] [--search-file file]" >&2
            exit 1
            ;;
    esac
done

if [[ ! -d "$RESULTS_DIR" ]]; then
    echo "Dossier $RESULTS_DIR introuvable" >&2
    exit 1
fi

if [[ -z "$SEARCH_FILE" ]]; then
    SEARCH_FILE="$RESULTS_DIR/exploitation_suggestions.txt"
fi

: >"$SEARCH_FILE"

if command -v searchsploit >/dev/null; then
    SEARCHSPLOIT_AVAILABLE=1
else
    echo "ℹ️  searchsploit non trouvé, suggestions non générées" >&2
    SEARCHSPLOIT_AVAILABLE=0
fi

for xml in "$RESULTS_DIR"/*_vuln.xml; do
    [[ ! -f "$xml" ]] && continue
    host=$(basename "$xml" _vuln.xml)
    echo "[+] Phase d'exploitation pour $host"

    cve_file="$RESULTS_DIR/${host}_cves.list"
    if [[ $SEARCHSPLOIT_AVAILABLE -eq 1 && -s "$cve_file" ]]; then
        while read -r cve; do
            echo "## $host - $cve" >>"$SEARCH_FILE"
            searchsploit "$cve" >>"$SEARCH_FILE" 2>/dev/null || true
            echo >>"$SEARCH_FILE"
        done <"$cve_file"
    else
        echo "    -> Aucune CVE ou searchsploit indisponible"
    fi

    echo "    -> Ici, ajoutez vos commandes d'exploitation (Metasploit, scripts)"
done

echo "✅ Exploitation terminée (si configurée)"
[[ -s "$SEARCH_FILE" ]] && echo "📄 Suggestions enregistrées dans $SEARCH_FILE"
