#!/bin/bash
# pentest_discovery.sh - Phase de découverte pour pentesting automatisé
set -euo pipefail

# Dossier du script pour localiser les ressources quel que soit le répertoire courant
SCRIPT_DIR="$(dirname "$(realpath "$0")")"

# Fichier contenant la liste des cibles (une adresse IP ou domaine par ligne)
TARGET_LIST="$SCRIPT_DIR/../../targets.txt"

# Dossier de sortie pour les résultats
OUTPUT_DIR="pentest_results"
mkdir -p "$OUTPUT_DIR"

# Options Nmap pour collecter un maximum d'informations utiles :
# -sC : scripts par défaut
# -sV : détection de versions
# -O  : détection d'OS
# --script vuln : scripts de vulnérabilités connus
NMAP_OPTS="-sC -sV -O --script vuln"

# Vérifie l'existence du fichier de cibles
if [[ ! -f "$TARGET_LIST" ]]; then
    echo "❌ Fichier $TARGET_LIST introuvable" >&2
    exit 1
fi

# Avertissement si non root
if [[ $EUID -ne 0 ]]; then
    echo "⚠️ Ce script devrait être exécuté en tant que root pour une détection complète (OS, ports ICMP...)" >&2
fi

# Lecture de chaque cible
while IFS= read -r target; do
    [[ -z "$target" ]] && continue
    echo "[+] Scan complet de $target"
    output_file="${OUTPUT_DIR}/${target//\//_}_discovery.xml"
    nmap $NMAP_OPTS -oX "$output_file" "$target"
done < "$TARGET_LIST"

echo "✅ Résultats enregistrés dans : $OUTPUT_DIR/"
