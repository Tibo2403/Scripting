#!/bin/bash
# pentest_discovery.sh - Phase de découverte pour pentesting automatisé
# ⚠️  Utiliser uniquement avec autorisation explicite (voir README)
set -euo pipefail

# Dossier du script pour localiser les ressources quel que soit le répertoire courant
SCRIPT_DIR="$(dirname "$(realpath "$0")")"
# Racine du dépôt
REPO_ROOT="$(realpath "$SCRIPT_DIR/../..")"

# Fichier contenant la liste des cibles (une adresse IP ou domaine par ligne)
TARGET_LIST="$REPO_ROOT/targets.txt"

# Dossier de sortie pour les résultats
OUTPUT_DIR="$REPO_ROOT/pentest_results/$(date +%Y%m%d_%H%M%S)"

# Parse les paramètres optionnels
NMAP_USER_OPTS=""
usage() {
    echo "Usage: $0 [--targets fichier] [--outdir dossier] [--nmap-opts \"options\"]" >&2
    exit 1
}

while getopts ":-:" opt; do
    case "$opt" in
        -)
            case "$OPTARG" in
                targets)
                    TARGET_LIST="${!OPTIND}"; OPTIND=$((OPTIND + 1))
                    ;;
                outdir)
                    OUTPUT_DIR="${!OPTIND}"; OPTIND=$((OPTIND + 1))
                    ;;
                nmap-opts)
                    NMAP_USER_OPTS="${!OPTIND}"; OPTIND=$((OPTIND + 1))
                    ;;
                *)
                    usage
                    ;;
            esac
            ;;
        *)
            usage
            ;;
    esac
done
shift $((OPTIND - 1))

mkdir -p "$OUTPUT_DIR"
LOG_FILE="$OUTPUT_DIR/scan_errors.log"

# Options Nmap pour collecter un maximum d'informations utiles :
# -sC : scripts par défaut
# -sV : détection de versions
# -O  : détection d'OS
# --script vuln : scripts de vulnérabilités connus
NMAP_OPTS="-sC -sV -O --script vuln"
[[ -n "$NMAP_USER_OPTS" ]] && NMAP_OPTS="$NMAP_OPTS $NMAP_USER_OPTS"

# Vérifie l'existence du fichier de cibles
if [[ ! -f "$TARGET_LIST" ]]; then
    echo "❌ Fichier $TARGET_LIST introuvable" >&2
    exit 1
fi

# Avertissement si non root
if [[ $EUID -ne 0 ]]; then
    echo "⚠️ Ce script devrait être exécuté en tant que root pour une détection complète (OS, ports ICMP...)" >&2
fi

# Vérifie la présence de nmap
if ! command -v nmap >/dev/null 2>&1; then
    echo "❌ nmap introuvable, installez-le" >&2
    exit 1
fi

# Lecture de chaque cible
while IFS= read -r target; do
    [[ -z "$target" || "$target" =~ ^# ]] && continue
    echo "[+] Scan complet de $target"
    output_file="${OUTPUT_DIR}/${target//\//_}_discovery.xml"
    if ! nmap $NMAP_OPTS -oX "$output_file" "$target" 2>>"$LOG_FILE"; then
        echo "[!] Échec du scan de $target" >>"$LOG_FILE"
    fi
done < "$TARGET_LIST"

echo "✅ Résultats enregistrés dans : $OUTPUT_DIR/"
[[ -s "$LOG_FILE" ]] && echo "⚠️ Des erreurs se sont produites. Consultez $LOG_FILE" >&2
