#!/bin/bash
# pentest_verification.sh - Phase de vérification des vulnérabilités Nmap
set -euo pipefail

OUTPUT_DIR="pentest_results"
RESULTS_DIR="$OUTPUT_DIR"
SUMMARY_FILE="$RESULTS_DIR/summary_vuln.log"

mkdir -p "$RESULTS_DIR"
echo -e "Résumé des vulnérabilités - $(date)\n" > "$SUMMARY_FILE"

if [[ ! -d "$RESULTS_DIR" ]]; then
    echo "❌ Dossier $RESULTS_DIR introuvable." >&2
    exit 1
fi

count=0

for xml in "$RESULTS_DIR"/*_discovery.xml; do
    [[ ! -f "$xml" ]] && continue

    host=$(basename "$xml" _discovery.xml)
    echo -e "\n[🔎] Vérification des vulnérabilités pour : $host"

    # Si le fichier vulnérabilité existe déjà, on saute
    if [[ -f "$RESULTS_DIR/${host}_vuln.xml" ]]; then
        echo "ℹ️  Résultat déjà présent pour $host → ignoré"
        continue
    fi

    # Test ping rapide pour éviter les erreurs de scan
    if ! ping -c 1 -W 1 "$host" &>/dev/null; then
        echo "⚠️  Hôte $host injoignable → scan ignoré"
        echo "$host - Injoignable" >> "$SUMMARY_FILE"
        continue
    fi

    # Lancer le scan avec détection de vulnérabilités
    echo "[...] Scan Nmap vulnérabilités sur $host"
    nmap --script vuln -oX "$RESULTS_DIR/${host}_vuln.xml" "$host"

    echo "$host - Scan OK" >> "$SUMMARY_FILE"
    ((count++))
done

echo -e "\n✅ $count scan(s) effectué(s)."
echo "📄 Résumé disponible : $SUMMARY_FILE"
