#!/bin/bash
# pentest_verification.sh - Phase de vÃ©rification des vulnÃ©rabilitÃ©s Nmap
set -euo pipefail

OUTPUT_DIR="pentest_results"
RESULTS_DIR="$OUTPUT_DIR"
SUMMARY_FILE="$RESULTS_DIR/summary_vuln.log"

mkdir -p "$RESULTS_DIR"
echo -e "RÃ©sumÃ© des vulnÃ©rabilitÃ©s - $(date)\n" > "$SUMMARY_FILE"

if [[ ! -d "$RESULTS_DIR" ]]; then
    echo "âŒ Dossier $RESULTS_DIR introuvable." >&2
    exit 1
fi

count=0

for xml in "$RESULTS_DIR"/*_discovery.xml; do
    [[ ! -f "$xml" ]] && continue

    host=$(basename "$xml" _discovery.xml)
    echo -e "\n[ðŸ”Ž] VÃ©rification des vulnÃ©rabilitÃ©s pour : $host"

    # Si le fichier vulnÃ©rabilitÃ© existe dÃ©jÃ , on saute
    if [[ -f "$RESULTS_DIR/${host}_vuln.xml" ]]; then
        echo "â„¹ï¸  RÃ©sultat dÃ©jÃ  prÃ©sent pour $host â†’ ignorÃ©"
        continue
    fi

    # Test ping rapide pour Ã©viter les erreurs de scan
    if ! ping -c 1 -W 1 "$host" &>/dev/null; then
        echo "âš ï¸  HÃ´te $host injoignable â†’ scan ignorÃ©"
        echo "$host - Injoignable" >> "$SUMMARY_FILE"
        continue
    fi

    # Lancer le scan avec dÃ©tection de vulnÃ©rabilitÃ©s
    echo "[...] Scan Nmap vulnÃ©rabilitÃ©s sur $host"
    nmap --script vuln -oX "$RESULTS_DIR/${host}_vuln.xml" "$host"

    echo "$host - Scan OK" >> "$SUMMARY_FILE"
    ((count++))
done

echo -e "\nâœ… $count scan(s) effectuÃ©(s)."
echo "ðŸ“„ RÃ©sumÃ© disponible : $SUMMARY_FILE"
