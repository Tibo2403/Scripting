#!/bin/bash
# pentest_verification.sh - Phase de vérification des vulnérabilités Nmap + Metasploit
set -euo pipefail

OUTPUT_DIR="pentest_results"
RESULTS_DIR="$OUTPUT_DIR"
SUMMARY_FILE="$RESULTS_DIR/summary_vuln.log"

mkdir -p "$RESULTS_DIR"
echo -e "Résumé des vulnérabilités - $(date)\n" > "$SUMMARY_FILE"

if [[ ! -d "$RESULTS_DIR" ]]; then
    echo "❌ Dossier $RESULTS_DIR introuvable." >&2
    exit 1
fi

count=0

for xml in "$RESULTS_DIR"/*_discovery.xml; do
    [[ ! -f "$xml" ]] && continue

    host=$(basename "$xml" _discovery.xml)
    echo -e "\n[🔎] Vérification des vulnérabilités pour : $host"

    # Si le fichier vulnérabilité existe déjà, on saute
    if [[ -f "$RESULTS_DIR/${host}_vuln.xml" ]]; then
        echo "ℹ️  Résultat déjà présent pour $host → ignoré"
        continue
    fi

    # Test ping rapide pour éviter les erreurs de scan
    if ! ping -c 1 -W 1 "$host" &>/dev/null; then
        echo "⚠️  Hôte $host injoignable → scan ignoré"
        echo "$host - Injoignable" >> "$SUMMARY_FILE"
        continue
    fi

    # Lancer le scan avec détection de vulnérabilités
    echo "[...] Scan Nmap vulnérabilités sur $host"
    nmap --script vuln -oX "$RESULTS_DIR/${host}_vuln.xml" "$host"

    echo "[...] Scan OpenVAS sur $host"
    OPENVAS_XML="$RESULTS_DIR/${host}_openvas.xml"
    if command -v gvm-cli >/dev/null; then
        gvm-cli socket --gmp-username "${GVM_USER:-admin}" \
            --gmp-password "${GVM_PASSWORD:-admin}" \
            --xml "<start_scan target='$host'/>" > "$OPENVAS_XML" 2>/dev/null
        grep -oE 'CVE-[0-9]+-[0-9]+' "$OPENVAS_XML" | sort -u \
            > "$RESULTS_DIR/${host}_cves.list" || true
        echo "$host - OpenVAS OK" >> "$SUMMARY_FILE"
    else
        echo "$host - OpenVAS indisponible" >> "$SUMMARY_FILE"
    fi

    echo "$host - Scan Nmap OK" >> "$SUMMARY_FILE"
    ((count++))

    # Phase Metasploit automatique (recon uniquement)
    echo "[*] Lancement de Metasploit pour $host..."
    MSF_SCRIPT="$RESULTS_DIR/msfscan_${host}.rc"

    cat > "$MSF_SCRIPT" <<EOF
use auxiliary/scanner/portscan/tcp
set RHOSTS $host
set THREADS 10
run

use auxiliary/scanner/http/http_version
set RHOSTS $host
run

exit
EOF

    msfconsole -q -r "$MSF_SCRIPT" > "$RESULTS_DIR/msf_${host}.log" 2>&1

    echo "$host - Metasploit OK" >> "$SUMMARY_FILE"
done

echo -e "\n✅ $count scan(s) Nmap + Metasploit effectué(s)."
echo "📄 Résumé disponible : $SUMMARY_FILE"
