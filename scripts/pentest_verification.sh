#!/bin/bash
# pentest_verification.sh - Phase de v√©rification des vuln√©rabilit√©s
set -euo pipefail

if ! command -v nmap >/dev/null 2>&1; then
    echo "Erreur: nmap n'est pas install√©." >&2
    exit 1
fi

RESULTS_DIR="pentest_results_latest"

usage() {
    echo "Usage: $0 [-d results_dir]" >&2
}

while getopts "d:h" opt; do
    case $opt in
        d) RESULTS_DIR="$OPTARG";;
        h) usage; exit 0;;
        *) usage; exit 1;;
    esac
done

if [[ ! -d "$RESULTS_DIR" ]]; then
    echo "Dossier $RESULTS_DIR introuvable" >&2
    exit 1
fi

for xml in "$RESULTS_DIR"/*_discovery.xml; do
    [[ ! -f "$xml" ]] && continue
    host=$(basename "$xml" _discovery.xml)
    echo "[+] Tests de vuln√©rabilit√© pour $host"
    nmap --script vuln -oX "$RESULTS_DIR/${host}_vuln.xml" "$host"
done

echo "üìÑ R√©sultats des vuln√©rabilit√©s enregistr√©s dans $RESULTS_DIR/"
